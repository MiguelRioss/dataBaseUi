<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XLS → Orders JSON</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7fb }
    .wrap { max-width: 960px; margin: 40px auto; padding: 20px; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 12px }
    label.file { border: 1px dashed #cbd5e1; padding: 12px 14px; border-radius: 10px; cursor: pointer; background: #f8fafc }
    input[type=file] { display: none }
    .btn { appearance: none; border: 1px solid #cbd5e1; background: #0ea5e9; color: #fff; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600 }
    .btn:hover { filter: brightness(0.98) }
    .ghost { background: #fff; color: #0f172a; border-color: #cbd5e1 }
    textarea { width: 100%; min-height: 360px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-family: ui-monospace, Consolas, Monaco, monospace }
    .hint { color: #475569; font-size: 13px; margin: 6px 0 12px }
    .err { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 10px 12px; border-radius: 10px; margin: 10px 0; display: none; white-space: pre-wrap }
    .err.ok { display: block }
  </style>
  <script src="https://unpkg.com/read-excel-file@5.8.8/bundle/read-excel-file.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h2>Excel → Orders JSON</h2>
    <p class="hint">Each sheet row → one order. Keys are <code>event-0</code>, <code>event-1</code>, …</p>
    <div class="row">
      <label class="file">
        <input type="file" id="excel_file" accept=".xlsx,.xls" />
        Choose Excel file…
      </label>
      <button class="btn" id="convert_btn">Convert</button>
      <button class="btn ghost" id="download_btn" disabled>Download JSON</button>
    </div>
    <div id="err" class="err"></div>
    <textarea id="json_data" placeholder="{ your JSON will appear here }"></textarea>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const errBox = $('#err');
    function showErr(msg) { errBox.textContent = msg; errBox.classList.add('ok'); }
    function clearErr() { errBox.textContent = ''; errBox.classList.remove('ok'); }

    function normKey(s) {
      return String(s || '').replace(/^\uFEFF/, '').trim().replace(/\s+/g, '_').toLowerCase();
    }
    const toStr = v => (v == null ? "" : String(v).trim());
    const toISO = v => {
      if (!v) return new Date().toISOString();
      if (v instanceof Date) return v.toISOString();
      const d = new Date(v); return isNaN(d.getTime()) ? new Date().toISOString() : d.toISOString();
    };

    function inferCountryFromAddress(addr) {
      if (!addr) return null;
      const s = addr.trim().toUpperCase();
      if (/\bPORTUGAL|PT\b/.test(s)) return "PT";
      if (/\bITALIA|ITALY|IT\b/.test(s)) return "IT";
      if (/\bFRANCE|FR\b/.test(s)) return "FR";
      if (/\bSUISSE|SWITZERLAND|CH\b/.test(s)) return "CH";
      if (/\bUK|UNITED KINGDOM|GB\b/.test(s)) return "GB";
      return null;
    }

    const asX = v => String(v ?? "").trim().toUpperCase() === "X";
    function keyFor(i) { return `event-${i}`; }
    function isSample10(s) { return /\b10\s*ml\b|\b10ml\b/i.test(s); }
    function isSample60(s) { return /\b60\s*ml\b|\b60ml\b/i.test(s); }
    function isGiveaway(s) { return /\bgive\s*away\b|\bgratis\b|\bfree\b/i.test(s); }

    function makeDefaultStatus() {
      return {
        delivered: { status: false, date: null, time: null },
        acceptedInCtt: { status: false, date: null, time: null },
        accepted: { status: false, date: null, time: null },
        in_transit: { status: false, date: null, time: null },
        waitingToBeDelivered: { status: false, date: null, time: null },
      };
    }

    $('#convert_btn').addEventListener('click', async () => {
      clearErr();
      const file = $('#excel_file').files?.[0];
      if (!file) { showErr('Choose an .xlsx first.'); return; }

      try {
        const rows = await readXlsxFile(file);
        if (!rows || rows.length < 2) { showErr('No data rows found.'); return; }

        const headers = rows[0].map(h => normKey(h));
        const hi = Object.fromEntries(headers.map((h, i) => [h, i]));
        const at = (row, header) => { const i = hi[normKey(header)]; return i == null ? undefined : row[i]; };

        const out = {};
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          if (!r || r.every(v => v == null || v === "")) continue;

          const fullName = toStr(at(r, 'Name'));
          const email = toStr(at(r, 'E-mail'));
          const phone = toStr(at(r, 'Phone Number'));
          const address = toStr(at(r, 'Adress'));
          const city = null;
          const zip = null;
          const ctry = inferCountryFromAddress(address);
          const sended = at(r, 'Sended');
          const received = toStr(at(r, 'Received'));
          const tracking = toStr(at(r, 'Tracking')) || null;
          const paidCell = toStr(at(r, 'Paid'));

          const key = keyFor(i - 1);

          // items & totals
          let items = [];
          let amount_total = 0;
          let currency = "eur";

          if (isSample10(paidCell) || isSample60(paidCell) || isGiveaway(paidCell)) {
            if (isSample60(paidCell)) {
              items.push({ id: "sample_60ml", name: "60 ml sample", quantity: 1, unit_amount: 0 });
            } else {
              items.push({ id: "sample_10ml", name: "10 ml sample", quantity: 1, unit_amount: 0 });
            }
            amount_total = 0;
          } else {
            items.push({ id: "price_1", name: "IBOTINCTURE™ TOTAL EXTRACT (60 ML)", quantity: 1, unit_amount: 30000 });
            amount_total = 30000;
          }

          out[key] = {
            event_id: key,
            written_at: toISO(sended),
            name: fullName || null,
            email: email || null,
            amount_total,
            currency,
            items,
            metadata: {
              full_name: fullName || null,
              phone: phone || null,
              addr_line1: address || null,
              addr_city: city,
              addr_zip: zip,
              addr_ctry: ctry,
            },
            track_url: tracking,
            status: makeDefaultStatus(),
            metadata_raw: { original_paid_cell: paidCell || null }
          };
        }

        const json = JSON.stringify(out, null, 2);
        $('#json_data').value = json;
        $('#download_btn').disabled = false;
      } catch (e) {
        showErr('Failed to read file:\n' + (e?.message || e));
        console.error(e);
      }
    });

    $('#download_btn').addEventListener('click', () => {
      const json = $('#json_data').value || "{}";
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'orders-from-excel.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  </script>
</body>
</html>
